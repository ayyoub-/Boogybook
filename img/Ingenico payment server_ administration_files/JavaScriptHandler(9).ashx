define(["jquery"],function(){window.submenu=window.submenu||{};return PSP.Module.extend({initialize:function(n){var t=new window.submenu.SubMenuModel({subitems:n.items,timezoneUrl:n.timezoneUrl,currentMenuId:n.currentMenuId}),i=new window.submenu.SubMenuView({model:t})}})});$(function(){window.submenu=window.submenu||{};window.submenu.SubMenuModel=Backbone.Model.extend({getSubMenu:function(n,t){var i=[];_.each(this.subitems,function(r){var f="",u=" ",e=r.MenuId==t?"innerSubMenu menu-link linkselected":"innerSubMenu menu-link";n==r.MenuGroup&&(r.Fonct&&r.MenuActionUrl&&(f=" Fonct="+r.Fonct+" MenuActionUrl="+r.MenuActionUrl+" IsTest="+r.IsTest),r.Fonct=="New Window"&&(u=" target=_blank"),(r.Target=="blank"||r.Target=="_blank")&&(u=" target=_blank"),i.push({id:r.MenuId,cls:e,url:r.Url,target:u,onclick:f,title:r.Lib1}))});this.set("liObj",i)},windowTest:null,windowProd:null,menuactionModel:function(n){var r=$(n.currentTarget).attr("Fonct"),t=$(n.currentTarget).attr("MenuActionUrl"),u=$(n.currentTarget).attr("IsTest"),i="WIDTH="+screen.width+",HEIGHT=600,resizable,scrollbars,toolbar";switch(r){case"ListIncidents":u=="true"?this.windowTest==null||this.windowTest.closed?this.windowTest=window.open(t,"IncidentsTest",i):this.windowTest.focus():this.windowProd==null||this.windowProd.closed?this.windowProd=window.open(t,"IncidentsProd",i):this.windowProd.focus();break;case"NewIncident":window.open(t,"",i)}},defaults:{liObj:[],menuFound:!1,menuFoundItem:""},getSetOpenMenuItems:function(n,t){var r=t.subitems,i;for(this.set("menuFound",!1),i=0;i<r.length;i++)if(r[i].Url.toLowerCase().indexOf(n.toLowerCase())!==-1){this.set("menuFound",!0);this.set("menuFoundItem",r[i]);break}},fetch:function(n,t){$.ajax({url:n.ajaxURL,type:"POST",dataType:n.dataType,data:n.ajaxData,async:!1,success:function(n){t&&t(n)},error:function(n,t){onAjaxError(n,t)}})},optionConfirmation:function(){var n="",t={ajaxURL:this.attributes.timezoneUrl,ajaxData:"",dataType:"html"};return this.fetch(t,function(t){n=t}),n},initialize:function(n){if(!n||!n.subitems)throw new Error("sub menu items not found");this.subitems=n.subitems;_.bindAll(this,"getSubMenu","menuactionModel","getSetOpenMenuItems")}})});$(function(){window.submenu=window.submenu||{};window.submenu.SubMenuView=Backbone.View.extend({el:"#div-menu",events:{"click a.bgnone":"setNoSubItemSelected","click div.menu-prev-horizontal":"previousMenu","click div.menu-next-horizontal":"nextMenu","click li a.innerSubMenu":"menuaction","click li a.submenu":"setSelected","click #headernavigation li a":"clearTimeoutWithoutDelay","mouseenter #headernavigation li a.submenu":"implementDelayOnHover","mouseleave  #headernavigation li a.submenu":"implementDelayOnOut","mouseenter #mastedDiv":"mainDivHoverIn","mouseleave #mastedDiv":"mainDivHoverOut","click .openTimeZone":"openTimeZonePopup"},openTimeZonePopup:function(){var n=this.model.optionConfirmation();this.createKendoPopup(n)},createKendoPopup:function(n){var i=!0,t=$("#UpdateTimeZone");t!=null&&t.length>0&&(t.html(n).kendoWindow({actions:["Close"],modal:!0,title:"Timezone",visible:!1,resizable:!0,width:545,close:function(){i&&($("#lnk_UserTimeZone").html(window.newTimeZone),$("#UpdateTimeZone").find("#timeZoneStatus").html(""),$("#UpdateTimeZone").find("#timeZoneStatus").hide())}}).data("kendoWindow"),t.data("kendoWindow").center(),t.data("kendoWindow").open())},clearTimeoutWithoutDelay:function(n){window.clearTimeout(this.timeoutId);this.timeoutId=null;this.mainMenuMouseOver(n.currentTarget,!0)},mainMenuMouseOver:function(n,t){this.method=$(n).attr("method");this.menuGroup=$(n).attr("menugroup");t&&(this.clickedMenuGroup=this.menuGroup,this.clickedMethod=this.method);this.method=="loadSubMenu"&&this.loadSubMenu(null,this.menuGroup)},setNoSubItemSelected:function(n,t){var r=t!=null?t:$(n.currentTarget).attr("menuParameter"),i;this.clearSubMenu();this.$el.find("#"+r).addClass("select");this.selectedMenuItem=null;i=$("#headernavigation li.select a");this.clickedMethod=this.selectedMethod=$(i).attr("method");this.clickedMenuGroup=this.selectedMenuGroup=$(i).attr("menugroup")},implementDelayOnHover:function(n){var t=this,i=n.currentTarget;window.clearTimeout(this.timeoutId);this.timeoutId||(this.timeoutId=window.setTimeout(function(){t.timeoutId=null;t.clearSubMenu();t.mainMenuMouseOver(i)},300))},implementDelayOnOut:function(){this.timeoutId&&(window.clearTimeout(this.timeoutId),this.timeoutId=null)},clearSubMenu:function(){this.$el.find("#submenu").addClass("form-grid-Hidden");this.$el.find(".selected").removeClass("selected");this.$el.find(".select").removeClass("select")},mainDivHoverIn:function(){this.divMenuTimer&&(window.clearTimeout(this.divMenuTimer),this.divMenuTimer=null)},mainDivHoverOut:function(){var n=this;this.divMenuTimer||(this.divMenuTimer=window.setTimeout(function(){n.divMenuTimer=null;n.hideSubMenu(n)},500))},hideSubMenu:function(n){var i=null,t=null;typeof this.clickedMethod!="undefined"&&this.clickedMethod!=null?(i=this.clickedMethod,t=this.clickedMenuGroup):typeof this.selectedMethod!="undefined"&&this.selectedMethod!=null?(i=this.selectedMethod,t=this.selectedMenuGroup):this.clearSubMenu();i=="loadSubMenu"?this.loadSubMenu(null,t):this.setNoSubItemSelected(n,t)},setSelected:function(n,t){this.$el.find(".linkselected").removeClass("linkselected");this.selectedMenuItem=n!=null?n.currentTarget:t;$(this.selectedMenuItem).addClass("linkselected");$(this.selectedMenuItem).focus();var i=$("#headernavigation li.selected a");this.clickedMethod=this.selectedMethod=$(i).attr("method");this.clickedMenuGroup=this.selectedMenuGroup=$(i).attr("menugroup")},method:null,menuGroup:null,previousMenu:function(n){if(this.isLastclick=!0,!this.isPrevlast){this.isNextlast=!1;this.$el.find(".menu-next-horizontal").removeClass("menu-next-disabled-horizontal");var i=this.lastLi[0].offsetLeft+this.lastLi.outerWidth()+15,t=(n.pageX-this.divCurMenu.offset().left)*(i-this.divWidth)/this.divWidth;this.scrollMenu=this.scrollMenu-this.scrollIndex;t<=this.scrollMenu?(this.isFirstClick=!1,$(this.divCurMenu).animate({scrollLeft:this.scrollMenu},"slow"),this.$el.find(".menu-prev-horizontal").removeClass("menu-prev-disabled-horizontal")):(this.isFirstClick||($(this.divCurMenu).animate({scrollLeft:t},"slow"),this.isPrevlast=!0),this.scrollMenu=this.scrollMenu+this.scrollIndex,this.$el.find(".menu-prev-horizontal").addClass("menu-prev-disabled-horizontal"))}return!1},resetSubMenuParameters:function(){this.scrollMenu=0;this.scrollIndex=100;this.isPrevlast=!1;this.isNextlast=!1;this.isFirstClick=!0;this.isLastclick=!0;this.divCurMenu.css({overflow:"hidden"});this.divCurMenu.scrollLeft(0);this.lastLi=this.ul.find("li:last-child")},loadSubMenu:function(n,t){var r=t!=null?t:$(n.currentTarget).attr("menuParameter"),i,u,f;this.$el.find(".selected").removeClass("selected");this.$el.find(".select").removeClass("select");this.$el.find("#"+r).addClass("selected");this.$el.find("#submenu").removeClass("form-grid-Hidden");this.selectedMenuItem==undefined&&(this.selectedMenuItem=null);this.model.getSubMenu(r,this.options.model.attributes.currentMenuId);i="";_.each(this.model.attributes.liObj,function(n){i=i+'<li><a id="'+n.id+'" class="'+n.cls+'"  href="'+n.url+'"  '+n.onclick+n.target+' title="'+n.title+'"><span>'+n.title+"<\/span><\/a><\/li>"});u=this.options.model.attributes.currentMenuId;f=u;this.$el.find("#myogonemenu").html(i);this.$el.find("#myogonemenu li a#"+f).addClass("innerSubMenu menu-link linkselected");this.$el.find("#myogonemenu li:last").addClass("lastbgnone");this.resetSubMenuParameters();this.setSubMenuScroll()},menuaction:function(n){this.setSelected(n,this.selectedMenuItem);this.model.menuactionModel(n)},setSubMenuScroll:function(){var n=0;this.ul.find("li").each(function(){var t=$(this).outerWidth();$(this).attr("eleWidth",t);n+=t});n=parseInt(n)+50;this.ul.css("width",n+"px")},nextMenu:function(n){if(this.divWidth=this.divCurMenu.width(),this.isFirstClick=!0,!this.isNextlast){this.isPrevlast=!1;this.$el.find(".menu-prev-disabled-horizontal").removeClass("menu-prev-disabled-horizontal");var i=this.lastLi[0].offsetLeft+this.lastLi.outerWidth()+15,t=(n.pageX-this.divCurMenu.offset().left)*(i-this.divWidth)/this.divWidth;this.scrollMenu=this.scrollMenu+this.scrollIndex;t<=this.scrollMenu&&(t=t+50);t>=this.scrollMenu?($(this.divCurMenu).animate({scrollLeft:this.scrollMenu},"slow"),this.$el.find(".menu-next-disabled-horizontal").removeClass("menu-next-disabled-horizontal"),this.isLastclick=!1):(this.isLastclick||($(this.divCurMenu).animate({scrollLeft:t},"slow"),this.isNextlast=!0),this.scrollMenu=this.scrollMenu-this.scrollIndex,this.$el.find(".menu-next-horizontal").addClass("menu-next-disabled-horizontal"))}return!1},openMenu:function(n,t){if(n!=null&&n.length>1){var i="";this.model.getSetOpenMenuItems(n,t.model);this.model.attributes.menuFound?(this.loadSubMenu(null,this.model.attributes.menuFoundItem.MenuGroup),i=$('a[href="'+this.model.attributes.menuFoundItem.Url+'"]')[0],this.setSelected(null,i)):(i=$('#headernavigation a[href*="'+n+'"]'),i.length==1&&this.setNoSubItemSelected(null,i.parents("li:eq(0)").attr("id")))}},timeoutId:null,divMenuTimer:null,divCurMenu:null,ul:null,isClicked:!1,clickedMenuGroup:null,clickedMethod:null,scrollMenu:0,scrollIndex:100,isPrevlast:!1,isNextlast:!1,isFirstClick:!0,isLastclick:!0,divWidth:null,lastLi:null,selectedMenuGroup:null,selectedMethod:null,needToRefreshTimeZone:!1,currentMenuGroup:null,currentSeqId:null,currentSelectedItem:null,isMenuGroupAvaliable:null,getMenuGroup:function(){for(var n=0;n<this.options.model.attributes.subitems.length;n++)if(this.options.model.attributes.subitems[n].MenuId==this.options.model.attributes.currentMenuId){this.currentMenuGroup=this.options.model.attributes.subitems[n].MenuGroup;this.currentSeqId=this.options.model.attributes.subitems[n].SeqId;this.currentSelectedItem=$('a[href="'+this.options.model.attributes.subitems[n].Url+'"]');break}this.currentMenuGroup==null&&(location.href.indexOf("MenuGroupId")>0?(this.isMenuGroupAvaliable=!0,this.currentMenuGroup=this.getQueryStringParams("MenuGroupId")):this.currentMenuGroup="-1")},getQueryStringParams:function(n){for(var i,u=location.search.substring(1),r=u.split("&"),t=0;t<r.length;t++)if(i=r[t].split("="),i[0]==n)return decodeURIComponent(i[1])},openMenuOnPost:function(n){var i=this.options.model.attributes.currentMenuId,u=this.currentSeqId,t=this.currentMenuGroup,r=this.getQueryStringParams("menuLink");r!=undefined?this.openMenu(r,n):(this.clickedMenuGroup=t,t!=""?t=="-1"?(this.setNoSubItemSelected(null,t+i),this.clickedMethod="setNoSubItemSelected"):(this.loadSubMenu(null,t,t+i+u),this.clickedMethod="loadSubMenu"):(this.clickedMenuGroup="-14",this.clickedMethod="setNoSubItemSelected",this.setNoSubItemSelected(null,this.clickedMenuGroup)))},initialize:function(n){if(this.divCurMenu=this.$el.find("div.cvrmenu"),this.ul=this.$el.find("ul.cvrmenu"),this.divCurMenu.css({overflow:"hidden"}),this.divCurMenu.scrollLeft(0),this.divWidth=this.divCurMenu.width(),this.options.model.attributes.currentMenuId==""&&(this.options.model.attributes.currentMenuId="4"),n.model.subitems.length!=undefined&&n.model.subitems.length>0){if(this.model=n.model,_.bindAll(this,"setNoSubItemSelected","openMenu","previousMenu","resetSubMenuParameters","setSubMenuScroll","setSelected","hideSubMenu","loadSubMenu","menuaction","nextMenu","clearSubMenu","implementDelayOnHover","implementDelayOnOut","mainDivHoverIn","mainDivHoverOut","mainMenuMouseOver","clearTimeoutWithoutDelay","openMenuOnPost","getMenuGroup"),this.getMenuGroup(),this.$el.find("#"+this.currentMenuGroup).addClass("selected"),this.currentMenuGroup=="-1"){var t=this.currentMenuGroup+this.options.model.attributes.currentMenuId;this.setNoSubItemSelected(null,t)}else this.$el.find("#submenu").removeClass("form-grid-Hidden"),this.setSelected(null,this.currentSelectedItem),this.isMenuGroupAvaliable!=null&&this.loadSubMenu(null,this.currentMenuGroup);this.resetSubMenuParameters()}else this.getMenuGroup(),this.$el.find("#"+this.currentMenuGroup).addClass("selected"),this.currentMenuGroup=="-1"&&(t=this.currentMenuGroup+this.options.model.attributes.currentMenuId,this.setNoSubItemSelected(null,t)),this.resetSubMenuParameters()}})});